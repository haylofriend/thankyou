<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Redirecting to login…</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Runtime env (gives us HF_DASHBOARD_URL for safe fallback + LOGIN_PATH) -->
  <script src="/env.js"></script>

  <script>
    (function () {
      function normalizeRedirect(value, fallback) {
        if (!value) return fallback;
        try {
          var url = new URL(value, location.origin);
          if (url.origin !== location.origin) return fallback;
          return url.pathname + (url.search || '') + (url.hash || '');
        } catch (_) {
          return fallback;
        }
      }

      function canonicalLoginPath(raw) {
        var fallback = '/auth/google';
        if (typeof raw !== 'string') return fallback;
        var value = raw.trim();
        if (!value) return fallback;

        // Prevent accidental self-loop: /login should never be the loginPath
        if (value === '/login') return fallback;

        var origin = '';
        try {
          if (typeof location !== 'undefined' && location.origin) {
            origin = location.origin;
          }
        } catch (_) {}

        if (value.startsWith('http://') || value.startsWith('https://')) {
          try {
            var url = new URL(value, origin || 'https://www.haylofriend.com');
            if (origin && url.origin !== origin) return fallback;

            // Also guard against absolute URL that resolves to /login
            var path = url.pathname + (url.search || '') + (url.hash || '');
            if (path === '/login' || path.startsWith('/login?')) return fallback;

            return path;
          } catch (_) {
            return fallback;
          }
        }

        if (value.charAt(0) !== '/') return fallback;
        if (value === '/login' || value.startsWith('/login?')) return fallback;
        return value;
      }

      function go() {
        var params = new URLSearchParams(location.search);
        var fallback = window.HF_DASHBOARD_URL || '/your-impact';
        var redirectPath = normalizeRedirect(params.get('redirect') || '', fallback);

        // Canonical login path: window.LOGIN_PATH || /auth/google
        var loginPath = canonicalLoginPath(window.LOGIN_PATH);
        var target = loginPath + '?redirect=' + encodeURIComponent(redirectPath);
        location.replace(target);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', go, { once: true });
      } else {
        go();
      }
    })();
  </script>

  <!-- No-JS fallback: send to canonical login with default redirect -->
  <noscript>
    <meta http-equiv="refresh" content="0;url=/auth/google?redirect=/your-impact">
  </noscript>
</head>
<body>
  <p>Redirecting…</p>
</body>
</html>
