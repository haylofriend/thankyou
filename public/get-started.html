<!-- get-started.html (UI from Get-started-UI.html + preserved logic)
  Hardened:
  - Safe boot waits for DOM + Vue + Supabase
  - v-cloak removes mustache flash
  - Smart One-Click: session‚Üígo, else One Tap, else Google redirect
  - Default redirect target: /your-impact
-->
<!DOCTYPE html>
<html lang="en" class="h-full" style="color-scheme: dark light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0b0c" />
  <title>Thank‚ÄëYou Link ‚Äî One‚ÄëClick Auth</title>

  <!-- Performance Hints -->
  <link rel="preconnect" href="https://accounts.google.com" crossorigin>
  <link rel="preconnect" href="https://appleid.cdn-apple.com" crossorigin>
  <link rel="preconnect" href="https://gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    try {
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ink: '#e7e7ea', bg: '#0b0b0c', card: '#121214', hair: 'rgba(231,231,234,.12)',
              acc: '#4da3ff', good: '#15c39a', warn: '#ffcc00', bad: '#ff5a5a'
            },
            boxShadow: {
              soft: '0 8px 24px rgba(0,0,0,.35)',
              ring: '0 0 0 3px rgba(77,163,255,.35)'
            }
          }
        }
      }
    } catch (e) { console.error(e) }
  </script>
  <style>
    :root{--bg:#0b0b0c;--card:#121214;--ink:#e7e7ea;--hair:rgba(231,231,234,.12);--acc:#4da3ff}
    html,body{height:100%;background:var(--bg)!important}
    body{margin:0;min-height:100vh;color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','Helvetica Neue',Arial,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;overflow-x:hidden}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--hair);box-shadow:var(--shadow,0 8px 24px rgba(0,0,0,.35));backdrop-filter:blur(10px)}
    .pill{display:inline-flex;align-items:center;gap:.6rem;padding:.7rem 1rem;border-radius:999px;border:1px solid var(--hair);background:rgba(255,255,255,.05);transition:.25s ease;will-change:transform,background,border-color}
    .pill:hover{transform:translateY(-1px);border-color:rgba(231,231,234,.25);background:rgba(255,255,255,.08)}
    .pill:active{transform:translateY(0)}
    .primary{background:linear-gradient(180deg,rgba(77,163,255,.25),rgba(77,163,255,.12));border-color:rgba(77,163,255,.35)}
    .primary:hover{background:linear-gradient(180deg,rgba(77,163,255,.35),rgba(77,163,255,.18))}
    .spinner{border:2px solid rgba(255,255,255,.2);border-top-color:var(--acc);border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (prefers-reduced-motion: reduce){.pill,.spinner{transition:none;animation:none}}
    .focus-ring:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(77,163,255,.5)}
    [v-cloak]{display:none}
  </style>

  <!-- Runtime env injection (served by Vercel function) -->
  <script src="/env.js"></script>

  <!-- Third‚Äëparty SDKs (async to avoid blocking) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="h-full">
  <main id="app" class="max-w-[980px] mx-auto px-6 py-12" v-cloak>
    <!-- Hero -->
    <header class="text-center mb-10">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-[color:var(--hair)] text-xs text-white/70 mb-3">
        <span class="w-2 h-2 rounded-full bg-[color:var(--acc)] animate-pulse"></span>
        Smart Auth Engine
      </div>
      <h1 class="text-4xl md:text-5xl font-semibold tracking-tight">In. One Click.</h1>
      <p class="text-white/70 mt-2 max-w-[640px] mx-auto">If you‚Äôve approved before on this device, you‚Äôre in instantly via Google One Tap. Otherwise, the cleanest two‚Äëclick path with Google, Apple, or a Magic Link.</p>
    </header>

    <!-- Card -->
    <section class="glass rounded-3xl p-6 md:p-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <div class="text-xs uppercase text-white/60 mb-1">Smart Auth</div>
          <h2 class="text-xl md:text-2xl font-medium">One‚ÄëClick ‚ûú Session; Two‚ÄëClick ‚ûú Provider</h2>
          <p class="text-white/70 text-sm mt-1">Google One Tap (auto when eligible) ‚Ä¢ Sign in with Apple (privacy‚Äëfirst). Supabase stores the session.</p>
        </div>
        <button @click="smartOneClick" :disabled="busy" class="pill primary min-w-[180px] justify-center focus-ring" aria-label="Smart One‚ÄëClick sign in">
          <span v-if="!busy">‚ö° Smart One‚ÄëClick</span>
          <span v-else class="spinner" title="Working‚Ä¶" aria-live="polite"></span>
        </button>
      </div>

      <!-- Buttons -->
      <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-2" role="group" aria-label="Auth providers">
        <button @click="withGoogleRedirect" class="pill focus-ring justify-center" aria-label="Continue with Google">
          <span class="inline-flex items-center gap-2">
            <svg width="16" height="16" viewBox="0 0 48 48" aria-hidden="true"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303C33.914 31.255 29.407 34 24 34c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.869 4.065 29.761 2 24 2 12.955 2 4 10.955 4 22s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.651-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.817C14.297 16.733 18.789 14 24 14c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.869 4.065 29.761 2 24 2 16.318 2 9.656 6.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 42c5.356 0 10.207-2.053 13.79-5.385l-6.363-5.375C29.407 34 24.9 31.255 24 31.255c-5.211 0-9.703-2.733-11.123-6.817l-6.571 4.817C9.656 37.663 16.318 42 24 42z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303C34.914 31.255 29.407 34 24 34c-5.211 0-9.703-2.733-11.123-6.817l-6.571 4.817C9.656 37.663 16.318 42 24 42c8.837 0 16-7.163 16-16 0-1.341-.138-2.651-.389-3.917z"/></svg>
            Continue with Google
          </span>
        </button>
        <button @click="withAppleRedirect" class="pill focus-ring justify-center" aria-label="Continue with Apple">
          <span class="inline-flex items-center gap-2">
            <svg width="16" height="16" viewBox="0 0 14 17" aria-hidden="true"><path fill="currentColor" d="M13.31 13.03c-.31.73-.68 1.4-1.11 2.02-.58.83-1.05 1.4-1.41 1.69-.56.52-1.15.79-1.78.8-.45 0-1-.13-1.66-.39-.66-.26-1.27-.39-1.82-.39-.57 0-1.19.13-1.86.39-.67.26-1.22.39-1.66.39-.61-.01-1.21-.26-1.8-.76-.38-.33-.86-.93-1.46-1.78C.87 14.48.41 13.54.11 12.6c-.35-1.03-.53-2.02-.53-2.97 0-1.1.24-2.05.72-2.85.38-.64.89-1.14 1.54-1.52C2.47 4.83 3.18 4.62 4 4.61c.47 0 1.09.15 1.87.45.77.3 1.27.45 1.5.45.16 0 .69-.17 1.6-.51.86-.31 1.58-.44 2.16-.39 1.6.13 2.81.83 3.62 2.09-1.43.87-2.15 2.09-2.16 3.67 0 1.22.45 2.24 1.32 3.05zM9.79.34c0 .82-.3 1.59-.88 2.29-.71.83-1.56 1.31-2.49 1.24a2.6 2.6 0 0 1-.02-.31c0-.79.34-1.64.94-2.36A3.4 3.4 0 0 1 9.8 0c.01.11.01.22-.01.34z"/></svg>
            Continue with Apple
          </span>
        </button>
        <button @click="withMagicLink" class="pill focus-ring justify-center" aria-label="Magic Link sign in via email">
          ‚úâÔ∏è Magic Link
        </button>
      </div>

      <!-- One Tap container (GIS draws UI when eligible) -->
      <div id="oneTap" class="mt-2"></div>

      <p class="text-xs text-white/50 mt-4">Note: browsers cannot silently read your Google/Apple account. One Tap auto‚Äësurfaces for returning users on this domain; Apple always requires a click.</p>
    </section>

    <!-- Signed-in section -->
    <section class="mt-10 glass rounded-3xl p-6 md:p-8" v-if="user">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-full bg-white/10 flex items-center justify-center">üë§</div>
        <div>
          <div class="text-sm">Signed in</div>
          <div class="text-white/70 text-xs truncate max-w-[420px]">{{ user.email || user.phone || user.id }}</div>
        </div>
      </div>
      <div class="mt-4 flex gap-2">
        <button @click="goDashboard" class="pill primary focus-ring">Open Dashboard</button>
        <button @click="logout" class="pill focus-ring">Sign out</button>
      </div>
    </section>

    <!-- Toast / status area -->
    <div class="sr-only" aria-live="polite" aria-atomic="true">{{ liveStatus }}</div>
    <div v-if="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 glass rounded-full px-4 py-2 text-sm shadow-ring">{{ toast }}</div>
  </main>

  <!-- Core SDKs (deferred to end of body to avoid blocking) -->
  <script defer src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // Robust boot: wait for DOM + Vue + Supabase
    (function boot(){
      function start(){
        const VueLib = window.Vue
        const supaLib = window.supabase
        // wait for BOTH Vue & Supabase to avoid race conditions
        if(!VueLib || !supaLib){ return setTimeout(start, 30) }
        const { createApp, ref, onMounted } = VueLib

        createApp({
          setup(){
            // ===== ENV / CONSTANTS =====
            const SUPABASE_URL = window.SUPABASE_URL || ''
            const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || ''
            const DASHBOARD_URL = window.HF_DASHBOARD_URL || (location.origin + '/your-impact')
            const GOOGLE_CLIENT_ID = window.GOOGLE_CLIENT_ID || '' // optional for One Tap

            const supa = (SUPABASE_URL && SUPABASE_ANON_KEY && supaLib)
              ? supaLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
              : null

            // ===== STATE =====
            const user = ref(null)
            const busy = ref(false)
            const toast = ref('')
            const liveStatus = ref('')

            // ===== HELPERS =====
            const say = (msg)=>{ toast.value = msg; liveStatus.value = msg; setTimeout(()=> toast.value='', 2200) }
            const goDashboard = ()=> location.href = DASHBOARD_URL
            async function refreshUser(){ if(!supa) return; const { data:{ user: u } } = await supa.auth.getUser(); user.value = u }
            async function getSession(){ if(!supa) return null; const { data:{ session } } = await supa.auth.getSession(); return session }
            async function logout(){ if(!supa) return say('Supabase not configured'); await supa.auth.signOut(); user.value = null; say('Signed out') }

            // ===== GOOGLE ONE TAP (optional enhancement) =====
            function initOneTap(){
              if(!supa){ say('Supabase not configured'); return; }
              if(!window.google){ say('Launching Google redirect‚Ä¶'); withGoogleRedirect(); return; }
              if(!GOOGLE_CLIENT_ID){ say('Missing GOOGLE_CLIENT_ID; using Google redirect'); withGoogleRedirect(); return; }
              window.google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                auto_select: true,
                cancel_on_tap_outside: false,
                itp_support: true,
                callback: async (resp)=>{
                  try {
                    busy.value = true; liveStatus.value = 'Signing in with Google';
                    const { error } = await supa.auth.signInWithIdToken({ provider: 'google', token: resp.credential });
                    if(error) throw error;
                    await refreshUser(); goDashboard();
                  } catch (e) {
                    console.error(e); say('Google sign-in failed; using redirect'); busy.value = false; withGoogleRedirect();
                  }
                }
              });
              window.google.accounts.id.prompt(()=>{});
            }

            // ===== PROVIDER FLOWS (Supabase-native) =====
            async function withGoogleRedirect(){
              if(!supa) return say('Supabase not configured')
              try{ busy.value = true; liveStatus.value = 'Redirecting to Google‚Ä¶'
                const { error } = await supa.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: DASHBOARD_URL } })
                if(error) throw error
              }catch(e){ console.error(e); say('Could not start Google sign-in'); busy.value=false }
            }
            async function withAppleRedirect(){
              if(!supa) return say('Supabase not configured')
              try{ busy.value = true; liveStatus.value = 'Redirecting to Apple‚Ä¶'
                const { error } = await supa.auth.signInWithOAuth({ provider: 'apple', options: { redirectTo: DASHBOARD_URL } })
                if(error) throw error
              }catch(e){ console.error(e); say('Could not start Apple sign-in'); busy.value=false }
            }
            async function withMagicLink(){
              if(!supa) return say('Supabase not configured')
              const email = prompt('Email for a magic link:')
              if(!email) return
              try{ busy.value = true; liveStatus.value = 'Sending magic link‚Ä¶'
                const { error } = await supa.auth.signInWithOtp({ email, options: { emailRedirectTo: DASHBOARD_URL } })
                if(error) throw error
                say('Check your email for a secure sign-in link.')
              }catch(e){ console.error(e); say('Could not send magic link') }
              finally{ busy.value = false }
            }

            // ===== SMART ONE-CLICK =====
            async function smartOneClick(){
              if(!supa) return say('Supabase not configured');
              try{
                busy.value = true;
                const session = await getSession();
                if(session){ await refreshUser(); return goDashboard(); }
                busy.value = false;
                if(!window.google || !GOOGLE_CLIENT_ID){ return withGoogleRedirect(); }
                initOneTap();
              }catch(e){ console.error(e); busy.value=false; say('Could not complete one-click'); }
            }

            onMounted(async ()=>{
              if(!supa) return
              await refreshUser()
              const session = await getSession()
              if(session) return goDashboard()

              const qs = new URLSearchParams(location.search)
              if(qs.get('autostart') === '1') smartOneClick()
            })

            return { user, busy, toast, liveStatus, smartOneClick, withGoogleRedirect, withAppleRedirect, withMagicLink, goDashboard, logout }
          }
        }).mount('#app')
      }

      if(document.readyState === 'complete' || document.readyState === 'interactive') start();
      else window.addEventListener('DOMContentLoaded', start);
    })();
  </script>
</body>
</html>
