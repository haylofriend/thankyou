<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thank-You Link ‚Äî Dashboard</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: '#e7e7ea',
            bg: '#0b0b0c',
            card: '#121214',
            hair: 'rgba(231,231,234,.12)',
            acc: '#4da3ff',
            good: '#15c39a',
            warn: '#ffcc00',
            bad: '#ff5a5a'
          },
          animation: {
            'pulse-glow': 'pulse-glow 2s ease-in-out infinite alternate',
            'float': 'float 6s ease-in-out infinite',
            'ripple': 'ripple 1.5s linear infinite',
          },
          keyframes: {
            'pulse-glow': {
              '0%': { 'box-shadow': '0 0 5px rgba(77, 163, 255, 0.4)' },
              '100%': { 'box-shadow': '0 0 20px rgba(77, 163, 255, 0.8), 0 0 30px rgba(77, 163, 255, 0.4)' }
            },
            'float': { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
            'ripple': { '0%': { transform: 'scale(0.8)', opacity: '1' }, '100%': { transform: 'scale(2.5)', opacity: '0' } }
          }
        }
      }
    }
  </script>
  <!-- Runtime env (load from working API path) -->
  <script src="/env.js"></script>
  <script src="/haylo-auth.js"></script>
  <script>
    (function () {
      var targetPath = window.HF_DASHBOARD_URL || '/your-impact';
      var loginPath = (window.LOGIN_PATH || '/auth/google');
      var attempted = false;
      var fallbackTimer = setTimeout(runGate, 4000);

      function toLogin() {
        try {
          var url = new URL(loginPath, location.origin);
          url.searchParams.set('redirect', targetPath);
          location.replace(url.toString());
        } catch (_) {
          location.replace(loginPath + '?redirect=' + encodeURIComponent(targetPath));
        }
      }

      function runGate() {
        if (attempted) return;
        attempted = true;
        clearTimeout(fallbackTimer);
        try {
          var api = window.HayloAuth;
          if (api && typeof api.gate === 'function') {
            api.gate(targetPath).catch(function (err) {
              console.warn('Auth gate redirect failed', err);
              toLogin();
            });
            return;
          }
        } catch (error) {
          console.error('Auth gate threw an error', error);
        }
        toLogin();
      }

      if (window.HayloAuth && typeof window.HayloAuth.gate === 'function') {
        runGate();
      } else {
        window.addEventListener('hayloauth:ready', runGate, { once: true });
      }
    })();
  </script>
  <!-- Runtime env fallbacks (only if env.js missing values) -->
  <script>
    // Only-if-unset fallbacks (do not overwrite values that env.js sets)
    window.SUPABASE_URL      = window.SUPABASE_URL      || "";
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "";
  </script>
  <!-- Supabase (CDN) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0b0b0c;--card:#121214;--ink:#e7e7ea;--hair:rgba(231,231,234,.12);--acc:#4da3ff}
    html,body{height:100%;background:var(--bg)!important}
    body{margin:0;min-height:100vh;color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','Helvetica Neue',Arial,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;overflow-x:hidden}
    *,*::before,*::after{box-sizing:border-box}
    [v-cloak]{display:none!important}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--hair);box-shadow:0 8px 24px rgba(0,0,0,.35);backdrop-filter:blur(10px)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--hair);background:rgba(255,255,255,.05)}
    .gradient-text{background:linear-gradient(135deg,var(--acc),#8acbff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .ripple-effect{position:absolute;border-radius:50%;background:rgba(77,163,255,.4);transform:scale(0);animation:ripple 1.5s linear;pointer-events:none}
    .tick{position:relative}
    .tick:after{content:'';position:absolute;left:0;bottom:-2px;height:2px;width:100%;background:linear-gradient(90deg,transparent,rgba(77,163,255,.6),transparent)}
    .dot{width:6px;height:6px;border-radius:999px;background:var(--acc)}
    .mini-burst{pointer-events:none;position:fixed;inset:0;display:none}
    .mini-burst.active{display:block}
  </style>
</head>
<body>
<div id="app" class="max-w-[1160px] mx-auto px-6 py-8 pb-28" v-cloak>

  <!-- NAV -->
  <nav class="sticky top-0 z-40 backdrop-blur bg-black/30 border-b border-white/10 mb-6">
    <div class="max-w-[1160px] mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-6 h-6 rounded-md animate-pulse-glow" style="background:linear-gradient(135deg,var(--acc),#8acbff)"></div>
        <div class="tracking-[.14em] uppercase text-xs text-white/90">Thank-You Link</div>
      </div>
      <div class="flex items-center gap-2">
        <button class="pill" @click="copyLink">Copy Link</button>
        <button class="pill" @click="openPublic">Open public page</button>
        <img :alt="displayName" class="w-8 h-8 rounded-full border border-white/20" :src="avatarUrl">
      </div>
    </div>
  </nav>

  <!-- WOW STRIP -->
  <section class="grid md:grid-cols-4 gap-3">
    <div class="glass rounded-2xl p-4">
      <div class="text-xs uppercase text-white/60">Today so far</div>
      <div class="text-3xl font-semibold mt-1">{{ todayDisplay }}</div>
      <div class="text-xs text-white/60 mt-1 flex items-center gap-2"><span class="dot animate-pulse"></span>live ticks each tip</div>
    </div>
    <div class="glass rounded-2xl p-4">
      <div class="text-xs uppercase text-white/60">This week on pace</div>
      <div class="text-3xl font-semibold mt-1">{{ weekPaceDisplay }}</div>
      <div class="h-1 w-full bg-white/10 rounded mt-3 overflow-hidden">
        <div :style="{width: weekPct + '%'}" class="h-1 bg-[var(--acc)] transition-all"></div>
      </div>
    </div>
    <div class="glass rounded-2xl p-4">
      <div class="text-xs uppercase text-white/60">Earnings / minute</div>
      <div class="text-3xl font-semibold mt-1 tick">{{ perMinuteDisplay }}</div>
      <div class="text-xs text-white/60 mt-1">AHA: money moves while you sleep</div>
    </div>
    <div class="glass rounded-2xl p-4">
      <div class="text-xs uppercase text-white/60">Conversion</div>
      <div class="text-3xl font-semibold mt-1">{{ Math.round(convRate * 100) }}%</div>
      <div class="text-xs text-white/60 mt-1">visits ‚Üí thank-yous</div>
    </div>
  </section>

  <!-- CORE: Possibility ‚Üí Reality ‚Üí Bridge -->
  <section class="mt-8 grid lg:grid-cols-3 gap-6">
    <!-- Possibility -->
    <div class="glass rounded-2xl p-5">
      <div class="text-xs uppercase text-white/60">Possibility</div>
      <h3 class="text-2xl font-semibold mt-1">Project your upside</h3>
      <div class="mt-4 space-y-3">
        <div>
          <div class="flex justify-between text-xs text-white/60 mb-1"><span>Shares/day</span><span>{{ sharesPerDay }}</span></div>
          <input type="range" min="1" max="50" step="1" v-model.number="sharesPerDay" class="w-full">
        </div>
        <div class="grid grid-cols-3 gap-3 text-sm">
          <div>
            <div class="text-white/60 text-xs mb-1">Tip rate</div>
            <input type="range" min="0" max="1" step="0.01" v-model.number="assumeTipRate" class="w-full">
            <div class="mt-1">{{ Math.round(assumeTipRate * 100) }}%</div>
          </div>
          <div>
            <div class="text-white/60 text-xs mb-1">Avg tip</div>
            <input type="range" min="100" max="3000" step="50" v-model.number="assumeAvgTip" class="w-full">
            <div class="mt-1">{{ asCurrency(assumeAvgTip) }}</div>
          </div>
          <div>
            <div class="text-white/60 text-xs mb-1">Referral bonus</div>
            <input type="range" min="0" max="500" step="10" v-model.number="assumeRefCents" class="w-full">
            <div class="mt-1">{{ asCurrency(assumeRefCents) }}</div>
          </div>
        </div>
        <div class="mt-2 p-3 rounded-xl bg-white/5 border border-white/10">
          <div class="text-xs uppercase text-white/60">30-day potential</div>
          <div class="text-3xl font-semibold mt-1">{{ asCurrency(monthlyPotential) }}</div>
          <div class="text-xs text-white/60 mt-1">Assumptions adjustable anytime</div>
        </div>
      </div>
    </div>

    <!-- Reality -->
    <div class="glass rounded-2xl p-5">
      <div class="text-xs uppercase text-white/60">Reality</div>
      <h3 class="text-2xl font-semibold mt-1">What actually happened</h3>
      <div class="grid grid-cols-3 gap-3 mt-4 text-sm">
        <div class="glass rounded-xl p-3 text-center">
          <div class="text-white/60 text-xs">Tips</div>
          <div class="text-xl font-medium">{{ kpi.tipsCount }}</div>
        </div>
        <div class="glass rounded-xl p-3 text-center">
          <div class="text-white/60 text-xs">Shares</div>
          <div class="text-xl font-medium">{{ kpi.sharesCount }}</div>
        </div>
        <div class="glass rounded-xl p-3 text-center">
          <div class="text-white/60 text-xs">Reviews</div>
          <div class="text-xl font-medium">{{ kpi.reviewsCount }}</div>
        </div>
      </div>
      <div class="mt-4">
        <div class="text-xs uppercase text-white/60">Total received</div>
        <div class="text-lg font-semibold mt-1">{{ asCurrency(kpi.totalCents) }}</div>
      </div>
      <div class="mt-4">
        <div class="text-xs uppercase text-white/60">Payout</div>
        <div class="flex items-center justify-between mt-1">
          <div class="text-lg font-semibold">{{ asCurrency(payoutNextAmount) }}</div>
          <div class="text-sm text-white/60">{{ payoutNextLabel }}</div>
        </div>
        <div class="h-1 w-full bg-white/10 rounded mt-2 overflow-hidden">
          <div :style="{width: Math.round(payoutPct * 100) + '%'}" class="h-1 bg-[var(--acc)] transition-all"></div>
        </div>
      </div>
    </div>

    <!-- Bridge the Gap -->
    <div class="glass rounded-2xl p-5">
      <div class="text-xs uppercase text-white/60">Bridge</div>
      <h3 class="text-2xl font-semibold mt-1">Next-best actions</h3>
      <ul class="mt-3 space-y-2">
        <li v-for="task in tasks" :key="task.id" class="flex items-center justify-between p-3 rounded-xl border border-white/10 bg-white/5">
          <div class="flex items-center gap-3">
            <input type="checkbox" class="w-4 h-4 accent-[var(--acc)]" v-model="task.done" @change="maybeCelebrate">
            <div class="text-sm font-medium">{{ task.label }}</div>
          </div>
        </li>
      </ul>
      <button class="mt-3 w-full glass px-4 py-2 rounded-xl text-sm" @click="openCopilot">Open AI Co-Pilot</button>
    </div>
  </section>

  <!-- Ledger & Share blocks -->
  <section class="mt-8 grid lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 glass rounded-2xl p-5">
      <div class="text-xs uppercase text-white/60">Your Gratitude Ledger</div>
      <div class="mt-3 space-y-2 max-h-[340px] overflow-auto pr-1">
        <div v-for="e in events" :key="e.id" class="flex items-center justify-between p-3 rounded-xl border border-white/10 bg-white/5">
          <div class="flex items-center gap-3">
            <div class="w-2 h-2 rounded-full" :class="eventColor(e)"></div>
            <div class="text-sm">{{ e.label }}</div>
          </div>
          <div class="text-sm text-white/70" v-if="e.amount">{{ asCurrency(e.amount) }}</div>
          <div class="text-sm text-white/50" v-else>{{ e.type }}</div>
        </div>
        <div v-if="!events.length" class="text-white/60 text-sm">No entries yet‚Äîyour first share will light this up.</div>
      </div>
    </div>

    <div class="glass rounded-2xl p-5">
      <div class="text-xs uppercase text-white/60">One-tap share</div>
      <h3 class="text-2xl font-semibold mt-1">Invite a thank-you</h3>
      <p class="text-white/70 text-sm mt-2">Use a tested script or QR.</p>
      <div class="mt-3 grid grid-cols-2 gap-2">
        <button class="pill text-sm" @click="copyLink">Copy link</button>
        <button class="pill text-sm" @click="share">Share now</button>
        <button class="pill text-sm" @click="downloadQR">Download QR</button>
        <button class="pill text-sm" @click="copyDM">Copy DM script</button>
      </div>
      <div class="mt-4 p-3 rounded-xl bg-white/5 border border-white/10 text-xs">
        ‚ÄúQuick thank-you link for small kindnesses‚Äîevery bit helps. {{ shareUrl }}‚Äù
      </div>
      <canvas id="qr-canvas" class="hidden"></canvas>
    </div>
  </section>

  <!-- AI Drawer content (inline) -->
  <section class="mt-8 grid md:grid-cols-2 gap-6">
    <div class="glass rounded-2xl p-5">
      <div class="text-xs uppercase text-white/60">DM & Social Scripts</div>
      <ul class="mt-3 space-y-3 text-sm">
        <li v-for="script in aiScripts" :key="script.id" class="p-3 rounded-xl bg-black/20 border border-white/10">
          <div class="font-medium mb-1">{{ script.label }}</div>
          <div class="text-white/70">{{ script.text }}</div>
        </li>
      </ul>
      <button class="mt-3 pill text-xs" @click="genScripts">Regenerate</button>
    </div>
    <div class="glass rounded-2xl p-5">
      <div class="text-xs uppercase text-white/60">Affiliate introductions</div>
      <ul class="mt-3 space-y-3 text-sm">
        <li v-for="affiliate in affiliates" :key="affiliate.id" class="p-3 rounded-xl bg-black/20 border border-white/10">
          <div class="font-medium mb-1">{{ affiliate.label }}</div>
          <div class="text-white/70">{{ affiliate.text }}</div>
        </li>
      </ul>
      <button class="mt-3 pill text-xs" @click="genAffiliates">Refresh</button>
    </div>
  </section>

  <!-- Minimal celebration -->
  <div class="mini-burst" :class="{active: showBurst}">
    <div class="pointer-events-none fixed inset-0 flex items-center justify-center text-4xl">üéâ</div>
  </div>

</div>

<!-- Vue (CDN) -->
<script src="https://unpkg.com/vue@3"></script>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

// ===== ENV =====
const SUPABASE_URL = window.SUPABASE_URL || '';
const SUPABASE_KEY = window.SUPABASE_ANON_KEY || '';
const THANK_HOST   = window.THANK_HOST || 'https://grateful.haylofriend.com';
const LOGIN_PATH   = window.LOGIN_PATH || '/auth/google'; // your dedicated login page (optional)

const supabase = (SUPABASE_URL && SUPABASE_KEY && window.supabase)
  ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
  : null;

// ===== UTIL =====
async function copyToClipboard(text) {
  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(text);
      return true;
    }
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.setAttribute('readonly', '');
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    ta.style.top = '-9999px';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    return ok;
  } catch (err) {
    alert(`Copy this link: ${text}`);
    return false;
  }
}

function promotePrettyUrl(slugValue) {
  try {
    const value = typeof slugValue === 'string' ? slugValue.trim() : '';
    if (!value || value === 'your-name') return '';
    return `/@${encodeURIComponent(value.toLowerCase())}`;
  } catch {
    return '';
  }
}

function safeUrlJoin(base, path) {
  try {
    const url = new URL(base);
    const cleanPath = path.startsWith('/') ? path.slice(1) : path;
    url.pathname = url.pathname.replace(/\/+$/, '') + '/' + cleanPath;
    return url.toString();
  } catch {
    return base + (base.endsWith('/') ? '' : '/') + path.replace(/^\//, '');
  }
}

function asCurrency(amountCents) {
  try {
    const dollars = (amountCents || 0) / 100;
    return dollars.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
  } catch {
    return `$${((amountCents || 0) / 100).toFixed(2)}`;
  }
}

// ===== AI SCRIPTS MOCK =====
function buildDefaultScripts(name, slug) {
  const who = name || 'your team';
  const handle = slug ? `@${slug}` : '@your-handle';

  return [
    {
      id: 'cold-dm',
      label: 'DM script',
      text: `Hey! We just set up a Thank-You Link so we can tip and thank our best guests directly. Want a peek? ${handle}`
    },
    {
      id: 'table-tent',
      label: 'Table tent copy',
      text: `Scan to send gratitude. Tips, thanks, and word-of-mouth, all in one tap. Powered by Thank-You Link.`
    },
    {
      id: 'staff-pitch',
      label: 'Team huddle opener',
      text: `We're rolling out Thank-You Link so our regulars can tip, thank, and share us. It's one tap, fully optional, and 100% human.`
    }
  ];
}

function buildDefaultAffiliates(name) {
  const who = name || 'your restaurant';
  return [
    {
      id: 'referral',
      label: 'Referral message',
      text: `We started using Thank-You Link to let guests tip & thank our team in one tap. If you'd like an intro, let me know.`
    },
    {
      id: 'owner-email',
      label: 'Owner-to-owner email',
      text: `Subject: Quick win we've seen for staff tips\n\nWe're using Thank-You Link so guests can send tips and thanks in one tap. It's been a clean way to boost morale and word-of-mouth. Happy to share notes if useful.`
    }
  ];
}

// ===== STORY / KPI MOCKERS =====
function mockEvents() {
  const now = new Date();
  const base = [
    { id: 1, label: 'Google review', amount: 0,    type: 'review', time: now },
    { id: 2, label: 'Thank-you note', amount: 500, type: 'tip',    time: now },
    { id: 3, label: 'Shared with friend', amount: 0, type: 'share', time: now },
    { id: 4, label: 'Thank-you link used', amount: 1200, type: 'tip', time: now }
  ];
  return base;
}

function computeKpi(events) {
  const totalCents = events.reduce((sum, e) => sum + (e.amount || 0), 0);
  const tips = events.filter(e => e.amount > 0);
  const shares = events.filter(e => e.type === 'share');
  const reviews = events.filter(e => e.type === 'review');

  return {
    totalCents,
    tipsCount: tips.length,
    sharesCount: shares.length,
    reviewsCount: reviews.length
  };
}

function computePerMinute(totalCents, minutes = 1440) {
  if (!minutes) return 0;
  return (totalCents / minutes);
}

// ===== VUE APP =====
createApp({
  setup() {
    // ===== AUTH STATE =====
    const auth = ref({ loading: !!supabase, session: null });

    // ===== PROFILE & UI STATE =====
    const displayName = ref('You');
    const avatarUrl = ref('https://api.dicebear.com/7.x/initials/svg?seed=YOU&backgroundType=gradientLinear');
    const slug = ref('your-name');
    window.slug = slug;

    const earningsToday = ref(0);
    const earningsWeek = ref(0);
    const convRate = ref(0.18);
    const perMinute = ref(0);
    const perMinuteDisplay = computed(() => asCurrency(Math.round(perMinute.value)));
    const events = ref(mockEvents());
    const kpi = ref(computeKpi(events.value));

    const todayDisplay = computed(() => asCurrency(earningsToday.value));
    const weekPaceDisplay = computed(() => asCurrency(earningsWeek.value));
    const weekPct = computed(() => Math.round(convRate.value * 100));

    const sharesPerDay = ref(3);
    const assumeTipRate = ref(0.22);
    const assumeAvgTip = ref(900); // cents
    const assumeRefCents = ref(250); // cents

    const monthlyPotential = computed(() => {
      const touches = sharesPerDay.value * 30;
      const tipTouches = touches * assumeTipRate.value;
      const directTips = tipTouches * assumeAvgTip.value;
      const refs = touches * 0.12;
      const refValue = refs * assumeRefCents.value;
      return directTips + refValue;
    });

    const payoutNextAmount = ref(24000); // cents
    const payoutNextLabel = ref('Payout in 3 days');
    const payoutPct = ref(0.42);

    const aiScripts = ref(buildDefaultScripts(displayName.value, slug.value));
    const affiliates = ref(buildDefaultAffiliates(displayName.value));
    const tasks = ref([
      { id: 'print', label: 'Print your first table tent', done: false },
      { id: 'one-tap', label: 'Try sending a test tip from your phone', done: false },
      { id: 'staff-huddle', label: 'Have a 10-minute team huddle about ‚Äúthank-you‚Äù stories', done: false }
    ]);

    const showBurst = ref(false);
    let burstTimeout = null;
    const shareUrl = computed(() => {
      const pretty = promotePrettyUrl(slug.value);
      if (pretty) return safeUrlJoin(THANK_HOST, pretty);
      return safeUrlJoin(THANK_HOST, '/your-impact/demo');
    });

    const eventColor = (e) => {
      if (e.amount > 0) return 'bg-[var(--good)]';
      if (e.type === 'share') return 'bg-[var(--acc)]';
      if (e.type === 'review') return 'bg-[var(--ink)]';
      return 'bg-white/80';
    };

    async function copyLink() {
      const ok = await copyToClipboard(shareUrl.value);
      if (ok) maybeCelebrate();
    }

    function downloadQR() {
      try {
        const canvas = document.getElementById('qr-canvas');
        if (!canvas) return alert('No QR code yet.');
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = 'thank-you-link-qr.png';
        link.click();
      } catch (e) {
        alert('Unable to download QR. Please use your browser‚Äôs ‚ÄúSave image‚Äù option.');
      }
    }

    function share() {
      const url = shareUrl.value;
      const text = `Our Thank-You Link: ${url}`;
      if (navigator.share) {
        navigator.share({ title: 'Thank-You Link', text, url }).catch(() => {});
      } else {
        copyToClipboard(text);
      }
    }

    async function copyDM() {
      const script = aiScripts.value[0]?.text || '';
      const ok = await copyToClipboard(script);
      if (ok) maybeCelebrate();
    }

    function genScripts() {
      aiScripts.value = buildDefaultScripts(displayName.value, slug.value);
      maybeCelebrate();
    }

    function genAffiliates() {
      affiliates.value = buildDefaultAffiliates(displayName.value);
      maybeCelebrate();
    }

    function maybeCelebrate() {
      if (burstTimeout) clearTimeout(burstTimeout);
      showBurst.value = true;
      burstTimeout = setTimeout(() => { showBurst.value = false; }, 1200);
    }

    function openCopilot() {
      alert('Copilot will open here in a future release.');
    }

    function openPublic() {
      window.open(shareUrl.value, '_blank', 'noopener,noreferrer');
    }

    // ===== HYDRATION =====
    async function hydrateFromDb() {
      if (!supabase || !auth.value.session) return;

      const user = auth.value.session.user;
      const rawName = user.user_metadata?.full_name || user.user_metadata?.name || user.email || 'You';
      displayName.value = rawName;

      const initials = (rawName || 'You')
        .split(/\s+/)
        .map(p => p[0] || '')
        .join('')
        .slice(0, 2)
        .toUpperCase();

      avatarUrl.value = `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(initials)}&backgroundType=gradientLinear`;

      const hash = Math.abs(
        Array.from(rawName).reduce((acc, ch) => acc + ch.charCodeAt(0), 0)
      );
      const slugBase = (rawName || 'your-name')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '') || 'your-name';
      slug.value = `${slugBase}-${hash % 1000}`;

      earningsToday.value = 4300;
      earningsWeek.value = 24800;
      perMinute.value = computePerMinute(earningsWeek.value, 7 * 24 * 60);
      events.value = mockEvents();
      kpi.value = computeKpi(events.value);
      payoutNextAmount.value = 24000;
      payoutNextLabel.value = 'Payout in 3 days';
      payoutPct.value = 0.42;
    }

    // ===== AUTH HOOKS =====
    onMounted(async () => {
      if (!supabase) {
        auth.value.loading = false;
        return;
      }

      const { data, error } = await supabase.auth.getSession();
      if (error) {
        console.error('Error getting session:', error);
        auth.value.loading = false;
        return;
      }

      auth.value.session = data.session || null;
      auth.value.loading = false;

      if (auth.value.session) {
        await hydrateFromDb();
      }
    });

    if (supabase) {
      supabase.auth.onAuthStateChange(async (_event, s) => {
        auth.value.session = s;
        if (s) await hydrateFromDb();
      });
    }

    // ===== EXPOSE TO TEMPLATE =====
    return {
      auth,
      // profile & state
      displayName, avatarUrl, slug, kpi, events,
      earningsToday, earningsWeek, convRate,
      perMinuteDisplay, todayDisplay, weekPaceDisplay, weekPct,
      sharesPerDay, assumeTipRate, assumeAvgTip, assumeRefCents, monthlyPotential,
      payoutNextAmount, payoutNextLabel, payoutPct,
      aiScripts, affiliates, openCopilot, tasks, showBurst,
      // helpers
      asCurrency,
      // actions
      shareUrl, eventColor, copyLink, downloadQR, share, copyDM, genScripts, genAffiliates, maybeCelebrate, openPublic
    };
  }
}).mount('#app');
</script>
</body>
</html>
