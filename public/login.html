<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Redirecting to login…</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Runtime env (gives us HF_DASHBOARD_URL for safe fallback + LOGIN_PATH) -->
  <script src="/env.js"></script>

  <script>
    (function () {
      var DEFAULT_REDIRECT = '/your-impact';

      function normalizeRedirect(value, fallback) {
        if (!value) return fallback;
        try {
          var url = new URL(value, location.origin);
          if (url.origin !== location.origin) return fallback;
          return url.pathname + (url.search || '') + (url.hash || '');
        } catch (_) {
          return fallback;
        }
      }

      function preferredRedirect() {
        var fallback = DEFAULT_REDIRECT;
        var candidate = '';

        if (typeof window.HF_GET_STARTED_REDIRECT === 'string') {
          candidate = window.HF_GET_STARTED_REDIRECT.trim();
        }

        if (!candidate && typeof window.__HF_DEFAULT_REDIRECT_PATH === 'string') {
          candidate = window.__HF_DEFAULT_REDIRECT_PATH.trim();
        }

        if (!candidate && typeof window.HF_DASHBOARD_URL === 'string') {
          candidate = window.HF_DASHBOARD_URL.trim();
        }

        return normalizeRedirect(candidate || fallback, fallback);
      }

      function canonicalLoginPath(raw) {
        var fallback = '/auth/google';
        if (typeof raw !== 'string') return fallback;
        var value = raw.trim();
        if (!value) return fallback;
        if (value.startsWith('http://') || value.startsWith('https://')) {
          try {
            var url = new URL(value, location.origin);
            if (url.origin !== location.origin) return fallback;
            return url.pathname + (url.search || '') + (url.hash || '');
          } catch (_) {
            return fallback;
          }
        }
        if (value.charAt(0) !== '/') return fallback;
        return value;
      }

      function go() {
        var params = new URLSearchParams(location.search);
        var fallback = preferredRedirect();
        var redirectPath = normalizeRedirect(params.get('redirect') || '', fallback);

        // Canonical login path: window.LOGIN_PATH || /auth/google
        var loginPath = canonicalLoginPath(window.LOGIN_PATH);
        var target = loginPath + '?redirect=' + encodeURIComponent(redirectPath);
        location.replace(target);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', go, { once: true });
      } else {
        go();
      }
    })();
  </script>

  <!-- No-JS fallback: send to canonical login with default redirect -->
  <noscript>
    <meta http-equiv="refresh" content="0;url=/auth/google?redirect=/your-impact">
  </noscript>
</head>
<body>
  <p>Redirecting…</p>
</body>
</html>
