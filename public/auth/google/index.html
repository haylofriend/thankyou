<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Connecting with Google…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/env.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    (async function () {
      const params = new URLSearchParams(location.search);
      const redirectParam = params.get('redirect') || '/your-impact';

      const redirectPath =
        redirectParam.startsWith('/') ? redirectParam : '/your-impact';

      const SUPABASE_URL = window.SUPABASE_URL || '';
      const SUPABASE_KEY = window.SUPABASE_ANON_KEY || '';

      if (!SUPABASE_URL || !SUPABASE_KEY || !window.supabase) {
        console.error('Supabase env not configured on /auth/google');
        // If we can’t read Supabase here, send them back to /login to try again.
        location.replace(
          '/login?redirect=' + encodeURIComponent(redirectPath)
        );
        return;
      }

      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // 1) If we already have a session, just go to the target page.
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
          location.replace(redirectPath);
          return;
        }
      } catch (e) {
        console.warn('getSession failed on /auth/google', e);
      }

      // 2) If this URL contains tokens in the hash, we just returned from Supabase/Google.
      const hash = location.hash || '';
      if (hash.includes('access_token=')) {
        const hashParams = new URLSearchParams(hash.slice(1));

        const access_token = hashParams.get('access_token');
        const refresh_token = hashParams.get('refresh_token');

        if (access_token && refresh_token) {
          try {
            await supabaseClient.auth.setSession({
              access_token,
              refresh_token
            });
          } catch (e) {
            console.error('Error setting Supabase session from hash', e);
          }
        }

        // Clear hash so we don’t reprocess it
        history.replaceState(null, '', location.pathname + location.search);

        // Now go to target page
        location.replace(redirectPath);
        return;
      }

      // 3) No session and no tokens? We probably hit this URL directly → send back to /login.
      location.replace(
        '/login?redirect=' + encodeURIComponent(redirectPath)
      );
    })();
  </script>
  <style>
    html,body{height:100%;margin:0;background:#0b0b0c;color:#e7e7ea;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{height:100%;display:grid;place-items:center}
    .card{padding:24px 28px;border:1px solid #2a2a2b;border-radius:16px;background:#121214}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">Connecting to Google…</div>
  </div>
</body>
</html>
