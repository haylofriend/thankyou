<script>
  (async function () {
    const params = new URLSearchParams(location.search);
    const redirectParam = params.get('redirect') || '/your-impact';

    const redirectPath =
      redirectParam.startsWith('/')
        ? redirectParam
        : '/your-impact';

    const SUPABASE_URL = window.SUPABASE_URL || '';
    const SUPABASE_KEY = window.SUPABASE_ANON_KEY || '';

    if (!SUPABASE_URL || !SUPABASE_KEY || !window.supabase) {
      console.error('Supabase env not configured');
      // In worst case, just send them to dashboard and let that page handle it.
      location.replace(redirectPath);
      return;
    }

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 1) If we already have a session, don't start OAuth again â†’ just go to redirectPath
    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        location.replace(redirectPath);
        return;
      }
    } catch (e) {
      console.warn('getSession failed, continuing to OAuth', e);
    }

    // 2) If this URL contains access_token/refresh_token in the hash, it's a callback from Google.
    const hash = location.hash || '';
    if (hash.includes('access_token=')) {
      const hashParams = new URLSearchParams(hash.slice(1));

      const access_token = hashParams.get('access_token');
      const refresh_token = hashParams.get('refresh_token');
      const expires_in = parseInt(hashParams.get('expires_in') || '3600', 10);

      if (access_token && refresh_token) {
        try {
          await supabaseClient.auth.setSession({
            access_token,
            refresh_token
          }, {
            expires_in
          });
        } catch (e) {
          console.error('Error setting Supabase session from hash', e);
        }
      }

      // Clear the hash so we don't reprocess it
      history.replaceState(null, '', location.pathname + location.search);

      // Go to the target page
      location.replace(redirectPath);
      return;
    }

    // 3) Prevent multiple OAuth calls in case of re-renders
    if (window.__hayloGoogleLoginStarted) {
      return;
    }
    window.__hayloGoogleLoginStarted = true;

    // 4) Start the Google OAuth flow
    try {
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo:
            location.origin +
            '/auth/google?redirect=' +
            encodeURIComponent(redirectPath)
        }
      });

      if (error) {
        console.error('Google OAuth error', error);
        alert('Unable to start Google sign-in. Please try again.');
      }
    } catch (e) {
      console.error('Unexpected error during OAuth', e);
      alert('Something went wrong starting sign-in.');
    }
  })();
</script>
