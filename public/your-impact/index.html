<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thank-You Link ‚Äî Dashboard</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: '#e7e7ea',
            bg: '#0b0b0c',
            card: '#121214',
            hair: 'rgba(231,231,234,.12)',
            acc: '#4da3ff',
            good: '#15c39a',
            warn: '#ffcc00',
            bad: '#ff5a5a'
          },
          animation: {
            'pulse-glow': 'pulse-glow 2s ease-in-out infinite alternate',
            'float': 'float 6s ease-in-out infinite',
            'ripple': 'ripple 1.5s linear infinite',
          },
          keyframes: {
            'pulse-glow': {
              '0%': { 'box-shadow': '0 0 5px rgba(77, 163, 255, 0.4)' },
              '100%': { 'box-shadow': '0 0 20px rgba(77, 163, 255, 0.8), 0 0 30px rgba(77, 163, 255, 0.4)' }
            },
            'float': { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
            'ripple': { '0%': { transform: 'scale(0.8)', opacity: '1' }, '100%': { transform: 'scale(2.5)', opacity: '0' } }
          }
        }
      }
    }
  </script>
  <!-- Runtime env (load from working API path) -->
  <script src="/env.js"></script>
  <script src="/haylo-auth.js"></script>
  <script>
    (function () {
      var targetPath = window.HF_DASHBOARD_URL || '/your-impact';
      var loginPath = (window.LOGIN_PATH || '/auth/google');
      var attempted = false;
      var fallbackTimer = setTimeout(runGate, 4000);

      function toLogin() {
        try {
          var url = new URL(loginPath, location.origin);
          url.searchParams.set('redirect', targetPath);
          location.replace(url.toString());
        } catch (_) {
          location.replace(loginPath + '?redirect=' + encodeURIComponent(targetPath));
        }
      }

      function runGate() {
        if (attempted) return;
        attempted = true;
        clearTimeout(fallbackTimer);
        try {
          var api = window.HayloAuth;
          if (api && typeof api.gate === 'function') {
            api.gate(targetPath).catch(function (err) {
              console.warn('Auth gate redirect failed', err);
              toLogin();
            });
            return;
          }
        } catch (error) {
          console.error('Auth gate threw an error', error);
        }
        toLogin();
      }

      if (window.HayloAuth && typeof window.HayloAuth.gate === 'function') {
        runGate();
      } else {
        window.addEventListener('hayloauth:ready', runGate, { once: true });
      }
    })();
  </script>
  <!-- Runtime env fallbacks (only if env.js missing values) -->
  <script>
    // Only-if-unset fallbacks (do not overwrite values that env.js sets)
    window.SUPABASE_URL      = window.SUPABASE_URL      || "";
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "";
  </script>
  <!-- Supabase (CDN) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0b0b0c;--card:#121214;--ink:#e7e7ea;--hair:rgba(231,231,234,.12);--acc:#4da3ff}
    html,body{height:100%;background:var(--bg)!important}
    body{margin:0;min-height:100vh;color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','Helvetica Neue',Arial,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;overflow-x:hidden}
    *,*::before,*::after{box-sizing:border-box}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--hair);box-shadow:0 8px 24px rgba(0,0,0,.35);backdrop-filter:blur(10px)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--hair);background:rgba(255,255,255,.05)}
    .gradient-text{background:linear-gradient(135deg,var(--acc),#8acbff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .ripple-effect{position:absolute;border-radius:50%;background:rgba(77,163,255,.4);transform:scale(0);animation:ripple 1.5s linear;pointer-events:none}
    .fade-in{opacity:0;transform:translateY(18px);transition:opacity .6s ease,transform .6s ease}
    .fade-in.visible{opacity:1;transform:translateY(0)}
    .tick{position:relative}
    .tick:after{content:'';position:absolute;left:0;bottom:-2px;height:2px;width:100%;background:linear-gradient(90deg,transparent,rgba(77,163,255,.6),transparent)}
    .dot{width:6px;height:6px;border-radius:999px;background:var(--acc)}
    .mini-burst{pointer-events:none;position:fixed;inset:0;display:none}
    .mini-burst.active{display:block}
  </style>
</head>
<body>
<div id="app" class="max-w-[1160px] mx-auto px-6 py-8 pb-28" v-cloak>

  <!-- AUTH-GATE OVERLAY -->
  <div v-if="auth.loading" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70">
    <div class="glass rounded-2xl p-6 w-[420px]">
      <div class="text-xs uppercase text-white/60">Checking sign-in‚Ä¶</div>
      <div class="mt-2 text-lg">Please wait</div>
    </div>
  </div>

  <!-- NAV -->
  <nav class="sticky top-0 z-40 backdrop-blur bg-black/30 border-b border-white/10 mb-6">
    <div class="max-w-[1160px] mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-6 h-6 rounded-md animate-pulse-glow" style="background:linear-gradient(135deg,var(--acc),#8acbff)"></div>
        <div class="tracking-[.14em] uppercase text-xs text-white/90">Thank-You Link</div>
      </div>
      <div class="flex items-center gap-2">
        <button class="pill relative overflow-hidden" @click="copyLink"><span class="text-xs">Copy Link</span>
          <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path d="M8 4a3 3 0 013-3h5a3 3 0 013 3v5a3 3 0 01-3 3h-1V8a4 4 0 00-4-4H8V4z"/><path d="M2 8a4 4 0 014-4h5a4 4 0 014 4v5a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/></svg>
        </button>
        <button class="pill relative overflow-hidden text-xs" @click="openPublic">Open public page</button>
        <img :alt="displayName" class="w-8 h-8 rounded-full border border-white/20" :src="avatarUrl">
      </div>
    </div>
  </nav>

  <!-- WOW STRIP -->
  <section class="grid md:grid-cols-4 gap-3">
    <div class="glass rounded-2xl p-4">
      <div class="text-xs uppercase text-white/60">Today so far</div>
      <div class="text-3xl font-semibold mt-1">$ {{ todayDisplay }}</div>
      <div class="text-xs text-white/60 mt-1 flex items-center gap-2"><span class="dot animate-pulse"></span>live ticks each tip</div>
    </div>
    <div class="glass rounded-2xl p-4">
      <div class="text-xs uppercase text-white/60">This week on pace</div>
      <div class="text-3xl font-semibold mt-1">$ {{ weekPaceDisplay }}</div>
      <div class="h-1 w-full bg-white/10 rounded mt-3 overflow-hidden">
        <div :style="{width: weekPct + '%'}" class="h-1 bg-[var(--acc)] transition-all"></div>
      </div>
    </div>
    <div class="glass rounded-2xl p-4">
      <div class="text-xs uppercase text-white/60">Earnings / minute</div>
      <div class="text-3xl font-semibold mt-1 tick">$ {{ perMinuteDisplay }}</div>
      <div class="text-xs text-white/60 mt-1">AHA: money moves while you sleep</div>
    </div>
    <div class="glass rounded-2xl p-4">
      <div class="text-xs uppercase text-white/60">Conversion</div>
      <div class="text-3xl font-semibold mt-1">{{ (convRate*100).toFixed(0) }}%</div>
      <div class="text-xs text-white/60 mt-1">visits ‚Üí thank-yous</div>
    </div>
  </section>

  <!-- CORE: Possibility ‚Üí Reality ‚Üí Bridge -->
  <section class="mt-8 grid lg:grid-cols-3 gap-6">
    <!-- Possibility -->
    <div class="glass rounded-2xl p-5">
      <div class="text-xs uppercase text-white/60">Possibility</div>
      <h3 class="text-2xl font-semibold mt-1">Project your upside</h3>
      <div class="mt-4 space-y-3">
        <div>
          <div class="flex justify-between text-xs text-white/60 mb-1"><span>Shares/day</span><span>{{ sharesPerDay }}</span></div>
          <input type="range" min="1" max="50" v-model.number="sharesPerDay" class="w-full">
        </div>
        <div class="grid grid-cols-3 gap-3 text-sm">
          <div><div class="text-white/60 text-xs mb-1">Tip rate</div><input type="range" min="5" max="80" v-model.number="assumeTipRate" class="w-full"><div class="mt-1">{{ assumeTipRate }}%</div></div>
          <div><div class="text-white/60 text-xs mb-1">Avg tip</div><input type="range" min="1" max="10" v-model.number="assumeAvgTip" class="w-full"><div class="mt-1">$ {{ assumeAvgTip }}</div></div>
          <div><div class="text-white/60 text-xs mb-1">Ref cut</div><input type="range" min="0" max="100" v-model.number="assumeRefCents" class="w-full"><div class="mt-1">{{ assumeRefCents }}¬¢</div></div>
        </div>
        <div class="mt-2 p-3 rounded-xl bg-white/5 border border-white/10">
          <div class="text-xs uppercase text-white/60">30-day potential</div>
          <div class="text-3xl font-semibold mt-1">$ {{ monthlyPotential.toFixed(0) }}</div>
          <div class="text-xs text-white/60 mt-1">Assumptions adjustable anytime</div>
        </div>
      </div>
    </div>

    <!-- Reality -->
    <div class="glass rounded-2xl p-5">
      <div class="text-xs uppercase text-white/60">Reality</div>
      <h3 class="text-2xl font-semibold mt-1">What actually happened</h3>
      <div class="grid grid-cols-3 gap-3 mt-4 text-sm">
        <div class="glass rounded-xl p-3 text-center">
          <div class="text-white/60 text-xs">Tips</div>
          <div class="text-xl font-medium">{{ kpi.tips }}</div>
        </div>
        <div class="glass rounded-xl p-3 text-center">
          <div class="text-white/60 text-xs">Connections</div>
          <div class="text-xl font-medium">{{ kpi.referrals }}</div>
        </div>
        <div class="glass rounded-xl p-3 text-center">
          <div class="text-white/60 text-xs">Approved</div>
          <div class="text-xl font-medium">$ {{ kpi.approved.toFixed(2) }}</div>
        </div>
      </div>
      <div class="mt-4">
        <div class="text-xs uppercase text-white/60">Payout</div>
        <div class="flex items-center justify-between mt-1">
          <div class="text-lg font-semibold">$ {{ payoutNextAmount.toFixed(2) }}</div>
          <div class="text-sm text-white/60">{{ payoutNextLabel }}</div>
        </div>
        <div class="h-1 w-full bg-white/10 rounded mt-2 overflow-hidden"><div :style="{width: payoutPct + '%'}" class="h-1 bg-[var(--acc)] transition-all"></div></div>
        <div class="mt-2 flex items-center justify-between">
          <div class="text-xs text-slate-400">
            Payout next Friday
          </div>
          <button
            id="sourceButton"
            type="button"
            class="inline-flex items-center gap-1 text-[11px] px-3 py-1 rounded-full border border-amber-300/40 bg-white/0 text-amber-100 hover:bg-amber-400/10 hover:border-amber-300 hover:text-amber-50 cursor-pointer shadow-sm hover:shadow-[0_0_0_1px_rgba(251,191,36,0.45)] transition-transform transition-shadow duration-150 ease-out hover:-translate-y-0.5"
            title="See exactly how this payout is calculated"
          >
            <span class="h-1.5 w-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
            <span class="uppercase tracking-wide">Source</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Bridge the Gap -->
    <div class="glass rounded-2xl p-5">
      <div class="text-xs uppercase text-white/60">Bridge</div>
      <h3 class="text-2xl font-semibold mt-1">Next-best actions (AI-assisted)</h3>
      <ul class="mt-3 space-y-2">
        <li v-for="(t, i) in tasks" :key="i" class="flex items-center justify-between p-3 rounded-xl border border-white/10 bg-white/5">
          <div class="flex items-center gap-3">
            <input type="checkbox" class="w-4 h-4 accent-[var(--acc)]" v-model="t.done" @change="maybeCelebrate">
            <div>
              <div class="text-sm font-medium">{{ t.title }}</div>
              <div class="text-xs text-white/60">{{ t.meta }}</div>
            </div>
          </div>
          <button class="pill relative overflow-hidden text-xs" @click="t.act()">{{ t.cta }}</button>
        </li>
      </ul>
      <button class="mt-3 w-full glass px-4 py-2 rounded-xl text-sm" @click="openCopilot=true">Open AI Co-Pilot</button>
    </div>
  </section>

  <!-- Ledger & Share blocks -->
  <section class="mt-8 grid lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 glass rounded-2xl p-5">
      <div class="text-xs uppercase text-white/60">Your Gratitude Ledger</div>
      <div class="mt-3 space-y-2 max-h-[340px] overflow-auto pr-1">
        <div v-for="(e, idx) in events" :key="idx" class="flex items-center justify-between p-3 rounded-xl border border-white/10 bg-white/5">
          <div class="flex items-center gap-3">
            <div class="w-2 h-2 rounded-full" :class="eventColor(e.type)"></div>
            <div class="text-sm">{{ e.label }}</div>
          </div>
          <div class="text-sm text-white/70">{{ e.value }}</div>
        </div>
        <div v-if="!events.length" class="text-white/60 text-sm">No entries yet‚Äîyour first share will light this up.</div>
      </div>
    </div>

    <div class="glass rounded-2xl p-5">
      <div class="text-xs uppercase text-white/60">One-tap share</div>
      <h3 class="text-2xl font-semibold mt-1">Invite a thank-you</h3>
      <p class="text-white/70 text-sm mt-2">Use a tested script or QR.</p>
      <div class="mt-3 grid grid-cols-2 gap-2">
        <button class="pill relative overflow-hidden text-sm" @click="share('x')">Post on X</button>
        <button class="pill relative overflow-hidden text-sm" @click="share('sms')">Text a regular</button>
        <button class="pill relative overflow-hidden text-sm" @click="downloadQR">Download QR</button>
        <button class="pill relative overflow-hidden text-sm" @click="copyDM">Copy 1-line DM</button>
      </div>
      <div class="mt-4 p-3 rounded-xl bg-white/5 border border-white/10 text-xs">
        ‚ÄúQuick thank-you link for small kindnesses‚Äîevery bit helps. {{ shareUrl }}‚Äù
      </div>
    </div>
  </section>

  <!-- AI Co-Pilot (drawer) -->
  <div v-if="openCopilot" class="fixed inset-0 z-50 bg-black/60 flex items-end md:items-center md:justify-center p-4">
    <div class="glass rounded-2xl p-5 w-full max-w-2xl">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs uppercase text-white/60">AI Co-Pilot</div>
          <h3 class="text-xl font-semibold">Turn gratitude into revenue</h3>
        </div>
        <button class="pill text-xs" @click="openCopilot=false">Close</button>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <div class="rounded-xl border border-white/10 p-3 bg-white/5">
          <div class="text-xs uppercase text-white/60">Scripts</div>
          <ul class="mt-2 space-y-2 text-sm">
            <li v-for="(s, i) in aiScripts" :key="i" class="p-2 rounded-lg bg-black/20 border border-white/10">{{ s }}</li>
          </ul>
          <button class="mt-3 pill text-xs" @click="genScripts">Regenerate</button>
        </div>
        <div class="rounded-xl border border-white/10 p-3 bg-white/5">
          <div class="text-xs uppercase text-white/60">Affiliate picks</div>
          <ul class="mt-2 space-y-2 text-sm">
            <li v-for="(a, i) in affiliates" :key="i" class="p-2 rounded-lg bg-black/20 border border-white/10">
              <div class="font-medium">{{ a.title }}</div>
              <div class="text-white/60 text-xs">{{ a.pitch }}</div>
            </li>
          </ul>
          <button class="mt-3 pill text-xs" @click="genAffiliates">Refresh</button>
        </div>
      </div>
      <div class="mt-4 text-xs text-white/60">*All content is yours to edit‚ÄîAI drafts speed the first mile.</div>
    </div>
  </div>

  <!-- Minimal celebration -->
  <div class="mini-burst" :class="{active: showBurst}">
    <div class="pointer-events-none fixed inset-0 flex items-center justify-center text-4xl">üéâ</div>
  </div>

</div>

<!-- Vue (CDN) -->
<script src="https://unpkg.com/vue@3"></script>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

// ===== ENV =====
const SUPABASE_URL = window.SUPABASE_URL || '';
const SUPABASE_KEY = window.SUPABASE_ANON_KEY || '';
const THANK_HOST   = window.THANK_HOST || 'https://grateful.haylofriend.com';
const LOGIN_PATH   = window.LOGIN_PATH || '/auth/google'; // your dedicated login page (optional)

const supabase = (SUPABASE_URL && SUPABASE_KEY && window.supabase)
  ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
  : null;

// ===== UTIL =====
async function copyToClipboard(text) {
  try {
    if (navigator.clipboard && window.isSecureContext) { await navigator.clipboard.writeText(text); return true; }
    const ta = document.createElement('textarea'); ta.value = text; ta.style.position='fixed'; ta.style.left='-9999px'; ta.style.top='-9999px';
    document.body.appendChild(ta); ta.focus(); ta.select(); const ok=document.execCommand('copy'); document.body.removeChild(ta); return ok;
  } catch (err) { alert(`Copy this link: ${text}`); return false; }
}

function promotePrettyUrl(slugValue) {
  try {
    const value = typeof slugValue === 'string' ? slugValue.trim() : '';
    if (!value || value === 'your-name') return;
    const desiredPath = `/${encodeURIComponent(value)}/your-impact`;
    const suffix = `${location.search || ''}${location.hash || ''}`;
    if (location.pathname !== desiredPath) {
      history.replaceState(null, '', `${desiredPath}${suffix}`);
    }
  } catch (err) {
    console.warn('Failed to promote pretty URL', err);
  }
}

const app = createApp({
  setup(){
    // ===== AUTH STATE =====
    const auth = ref({ loading: !!supabase, session: null, email: '', sending: false });

    // ===== PROFILE & UI STATE =====
    const displayName = ref('You');
    const avatarUrl = ref('https://api.dicebear.com/7.x/initials/svg?seed=YOU&backgroundType=gradientLinear');
    const slug = ref('your-name');
    window.slug = slug;

    const earningsToday = ref(0);
    const earningsWeek = ref(0);
    const convRate = ref(0.28);
    const kpi = ref({ tips: 0, referrals: 0, approved: 0 });
    const events = ref([]);
    const openCopilot = ref(false);
    const showBurst = ref(false);

    // Projections
    const sharesPerDay = ref(10);
    const assumeTipRate = ref(30);
    const assumeAvgTip = ref(3);
    const assumeRefCents = ref(20);

    // Payouts
    const payoutNextAmount = ref(0);
    const payoutNextLabel = ref('Next Friday');
    const payoutPct = ref(20);

    window._THANKYOU_DASH = Object.assign(window._THANKYOU_DASH || {}, {
      payoutNextAmount,
    });

    // AI
    const aiScripts = ref([
      "X post: 'Shoutout to everyday helpers. If I‚Äôve helped you, here‚Äôs a $2 thank-you link‚Äîtiny support, big momentum.'",
      "SMS to regular: 'Grateful for you. If I‚Äôve made your day lately, this link is how folks tip me now. No pressure, just love.'",
      "IG caption: 'Kindness that circulates. Tap my thank-you link‚Äîevery $2 keeps this going.'"
    ]);
    const affiliates = ref([
      { title: "Instant QR Table Cards", pitch: "Order 10 for your counter‚Äîscan ‚Üí tip. 15% cash-back via your link."},
      { title: "Creator Banking", pitch: "No-fee payouts on Fridays; $10 referral for you + $10 for them."}
    ]);

    // ===== DERIVED =====
    const shareUrl = computed(()=> `${THANK_HOST}/thank/${slug.value}`);
    const perMinute = computed(()=> Math.max(earningsWeek.value,0) / (7*24*60));
    const perMinuteDisplay = computed(()=> perMinute.value.toFixed(2));
    const todayDisplay = computed(()=> earningsToday.value.toFixed(2));
    const weekPaceDisplay = computed(()=> Math.max(earningsWeek.value,0).toFixed(2));
    const weekPct = computed(()=> Math.min(100, Math.round((earningsWeek.value/100)*100)));
    const monthlyPotential = computed(()=>{
      const tipsPerDay = sharesPerDay.value * (assumeTipRate.value/100);
      const tipRev = tipsPerDay * assumeAvgTip.value * 30;
      const refRev = sharesPerDay.value * (assumeRefCents.value/100) * 30;
      return tipRev + refRev;
    });

    // ===== ACTIONS =====
    function eventColor(type){ return { tip:'bg-[var(--acc)]', share:'bg-[#15c39a]', payout:'bg-[#ffcc00]' }[type] || 'bg-white/20'; }

    async function copyLink(e){ createRipple(e); const ok = await copyToClipboard(shareUrl.value); events.value.unshift({label:'Link copied', value:shareUrl.value, type:'share'}); toast(ok?'Copied!':'Link ready'); }
    function downloadQR(e){ createRipple(e); alert('Demo: Beautiful QR would generate for ' + shareUrl.value); }
    async function share(kind){ const text = `Tiny thank-you link for little kindnesses: ${shareUrl.value}`; if(kind==='sms'){ window.open(`sms:?&body=${encodeURIComponent(text)}`,'_blank'); } if(kind==='x'){ window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(text)}`,'_blank'); } events.value.unshift({label:'Shared invitation', value:kind.toUpperCase(), type:'share'}); }
    async function copyDM(e){ createRipple(e); await copyToClipboard(`If I‚Äôve helped you lately, here‚Äôs a $2 thank-you: ${shareUrl.value}`); toast('DM copied'); }
    function genScripts(){ aiScripts.value = shuffle(aiScripts.value); toast('New scripts ready'); }
    function genAffiliates(){ affiliates.value = shuffle(affiliates.value); toast('Updated picks'); }
    const tasks = ref([
      { title:'Pin your link', meta:'Bio / profile / menu', cta:'Auto-copy', done:false, act:()=>copyLink(new Event('click')) },
      { title:'Post one story', meta:'Use AI script #1', cta:'Open Co-Pilot', done:false, act:()=>openCopilot.value=true },
      { title:'DM three regulars', meta:'Paste 1-liner', cta:'Copy DM', done:false, act:()=>copyDM(new Event('click')) },
    ]);
    function maybeCelebrate(){ if (tasks.value.every(t=>t.done)) { showBurst.value = true; setTimeout(()=> showBurst.value=false, 1200); } }

    function toast(msg){ const div = document.createElement('div'); div.textContent = msg; div.className = 'fixed bottom-5 left-1/2 -translate-x-1/2 px-3 py-1.5 rounded-full text-xs bg-white/10 backdrop-blur border border-white/10'; document.body.appendChild(div); setTimeout(()=> div.remove(), 1500); }
    function createRipple(event){ const button = event?.currentTarget || document.activeElement; if(!button) return; const circle=document.createElement('span'); const diameter=Math.max(button.clientWidth,button.clientHeight); const radius=diameter/2; circle.style.width=circle.style.height=`${diameter}px`; const rect=button.getBoundingClientRect(); circle.style.left=`${(event?.clientX||rect.left+radius)-rect.left-radius}px`; circle.style.top =`${(event?.clientY||rect.top +radius)-rect.top -radius}px`; circle.classList.add('ripple-effect'); const old = button.getElementsByClassName('ripple-effect')[0]; if(old) old.remove(); button.style.position='relative'; button.appendChild(circle); }

    function openPublic(e){ createRipple(e); window.open(shareUrl.value, '_blank', 'noopener,noreferrer'); }

    async function sendMagic(){
      if (!supabase) return alert('Supabase not configured');
      auth.value.sending = true;
      const redirectTo = new URL(window.location.href);
      redirectTo.searchParams.set('from', 'magic');
      const { error } = await supabase.auth.signInWithOtp({ email: auth.value.email, options: { emailRedirectTo: redirectTo.toString() } });
      auth.value.sending = false;
      if (error) return alert(error.message);
      alert('Check your inbox for the sign-in link.');
    }

    function goLogin(){
      const url = new URL(LOGIN_PATH, window.location.origin);
      url.searchParams.set('redirect', window.location.pathname);
      window.location.href = url.toString();
    }

    // ===== DATA LOAD (requires auth) =====
    async function hydrateFromDb(){
      // Get profile for slug + avatar
      const { data: profile, error } = await supabase.from('profiles').select('display_name, slug, avatar_url').eq('id', auth.value.session.user.id).single();
      if (!error && profile){
        displayName.value = profile.display_name || displayName.value;
        slug.value = profile.slug || slug.valueFromEmail() || auth.value.session.user.id.slice(0,8);
        avatarUrl.value = profile.avatar_url || avatarUrl.value;
      } else {
        // fallback slug from email user_metadata
        slug.value = slug.valueFromEmail() || auth.value.session.user.id.slice(0,8);
      }

      // Example totals (replace with RPCs you already have)
      const { data: sums } = await supabase.rpc('dashboard_totals').catch(()=>({ data:null }));
      if (sums){
        earningsToday.value = sums.today || 0;
        earningsWeek.value  = sums.week  || 0;
        kpi.value.tips      = sums.tips  || 0;
        kpi.value.referrals = sums.referrals || 0;
        kpi.value.approved  = sums.approved || 0;
      }
      const { data: ev } = await supabase.from('events').select('label,value,type').eq('user_id', auth.value.session.user.id).order('created_at',{ascending:false}).limit(20);
      events.value = (ev||[]);

      // Payout mock from DB
      payoutNextAmount.value = Math.max(kpi.value.approved - (sums?.paid||0), 0);
      payoutNextLabel.value = 'Friday';
      payoutPct.value = Math.min(100, Math.round((payoutNextAmount.value/100)*100));
    }

    // little helper on ref
    slug.valueFromEmail = () => {
      const email = auth.value?.session?.user?.email || '';
      return email ? email.split('@')[0].replace(/[^a-z0-9-_]/gi,'-').toLowerCase() : '';
    }

    function introWow(){
      const target = 23.40; let t=0;
      const step = ()=>{ t+=0.02; const v = target*(1-Math.exp(-3*t));
        earningsWeek.value = Math.min(target, +v.toFixed(2));
        payoutNextAmount.value = Math.max(earningsWeek.value*0.5, 0);
        payoutPct.value = Math.min(100, Math.round((earningsWeek.value/50)*100));
        if(earningsWeek.value < target) requestAnimationFrame(step);
      }; step();
      setTimeout(()=>earningsToday.value = +(target/7).toFixed(2), 600);
    }

    watch(slug, promotePrettyUrl);

    onMounted(async () => {
      promotePrettyUrl(slug.value);

      if (!supabase) {
        // No Supabase configured: keep the demo/overlay behavior.
        introWow && introWow();
        // Minute tick (visual compounding)
        setInterval(() => { earningsWeek.value += perMinute.value; }, 60000);
        return;
      }

      auth.value.loading = true;

      // 1) Initial read
      let { data: { session } } = await supabase.auth.getSession();

      // 2) Force a refresh (handles fresh returns from OAuth)
      if (!session) {
        try {
          const { data } = await supabase.auth.refreshSession();
          session = data?.session || null;
        } catch (_) {}
      }

      // 3) Short poll (max ~2.5s) to allow session to settle after redirect
      if (!session) {
        const deadline = Date.now() + 2500;
        while (!session && Date.now() < deadline) {
          await new Promise(r => setTimeout(r, 250));
          const res = await supabase.auth.getSession();
          session = res?.data?.session || null;
        }
      }

      auth.value.session = session;
      auth.value.loading = false;

      // 4) Subscribe so future refreshes/magic links hydrate automatically
      supabase.auth.onAuthStateChange(async (_event, s) => {
        auth.value.session = s;
        if (s) await hydrateFromDb();
      });

      // 5) Final decision
      if (auth.value.session) {
        // Auth OK ‚Üí render dashboard
        await hydrateFromDb();
      } else {
        // Still no session ‚Üí DO NOT auto-redirect (prevents loops).
        // The built-in gate will show, and "Open full login" already routes to /auth/google.
        // If you want a button-less auto-forward, we can add a delayed redirect later.
      }

      // existing visuals/timers
      setInterval(() => { earningsWeek.value += perMinute.value; }, 60000);
    });

    return {
      // auth
      auth, sendMagic, goLogin,
      // profile & state
      displayName, avatarUrl, slug, kpi, events,
      earningsToday, earningsWeek, convRate,
      perMinuteDisplay, todayDisplay, weekPaceDisplay, weekPct,
      sharesPerDay, assumeTipRate, assumeAvgTip, assumeRefCents, monthlyPotential,
      payoutNextAmount, payoutNextLabel, payoutPct,
      aiScripts, affiliates, openCopilot, tasks, showBurst,
      // actions
      shareUrl, eventColor, copyLink, downloadQR, share, copyDM, genScripts, genAffiliates, maybeCelebrate, openPublic
    };
  }
});
window.app = app;
</script>
<script>
  app.mount('#app');
</script>

<script>
  window.addEventListener('DOMContentLoaded', function () {
    const sourceBtn = document.getElementById('sourceButton');
    const overlay = document.getElementById('sourceOverlay');
    const iframe = document.getElementById('sourceFrame');
    const overlayClose = document.getElementById('sourceOverlayClose');

    // If elements aren‚Äôt present, quietly bail out
    if (!sourceBtn || !overlay || !iframe) return;

    function getNextPayoutAmountDollars() {
      try {
        const payoutRef = window._THANKYOU_DASH?.payoutNextAmount;
        const dollars = payoutRef ? Number(payoutRef.value) : 0;

        return Number.isFinite(dollars) ? Math.max(0, dollars) : 0;
      } catch (e) {
        console.warn('Could not read next payout amount', e);
        return 0;
      }
    }

    function openSourceOverlay() {
      const amount = getNextPayoutAmountDollars();
      const params = new URLSearchParams({
        amount: amount.toFixed(2),
      });

      iframe.src = '/source?' + params.toString();
      overlay.classList.remove('hidden');
    }

    function closeSourceOverlay() {
      overlay.classList.add('hidden');
      // Clear iframe to avoid stale content / extra network
      iframe.src = '';
    }

    // Open overlay when user clicks the ‚ÄúSource‚Äù button
    sourceBtn.addEventListener('click', openSourceOverlay);

    // Close when clicking the close button
    if (overlayClose) {
      overlayClose.addEventListener('click', closeSourceOverlay);
    }

    // Optional: close when clicking outside the iframe but inside overlay
    overlay.addEventListener('click', function (event) {
      if (event.target === overlay) {
        closeSourceOverlay();
      }
    });
  });
</script>
<!-- Replenish / Source overlay -->
<div
  id="sourceOverlay"
  class="fixed inset-0 bg-slate-950/70 backdrop-blur-sm z-50 hidden"
>
  <div class="w-full max-w-xl mx-auto h-[95vh] pt-6">
    <div
      class="relative h-full glass rounded-2xl border border-slate-700/70 bg-slate-950/95 overflow-hidden"
    >
      <div
        class="flex items-start justify-between px-4 pt-3 pb-2 border-b border-slate-800/70"
      >
        <div>
          <div class="text-[11px] uppercase tracking-[0.16em] text-slate-400">
            Transparency
          </div>
          <div class="text-sm text-slate-200">How your source is calculated</div>
        </div>
        <button
          type="button"
          id="sourceOverlayClose"
          class="text-xs text-slate-400 hover:text-white"
        >
          ‚úï
        </button>
      </div>

      <!-- The iframe that loads /source -->
      <iframe
        id="sourceFrame"
        src=""
        class="w-full h-[calc(95vh-3.25rem)] border-0 bg-slate-950"
        style="box-shadow: 0 24px 80px rgba(15,23,42,0.9);"
      ></iframe>

      <div
        class="px-4 py-2 text-[10px] text-slate-500 flex items-center justify-between border-t border-slate-800/70"
      >
        <span
          >Click outside or press <span class="font-semibold text-slate-300">Esc</span>
          to close.</span
        >
        <span class="uppercase tracking-[0.16em] text-slate-500">Replenish</span>
      </div>
    </div>
  </div>
</div>
</body>
</html>
