<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Redirecting to login…</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Runtime env (gives us HF_DASHBOARD_URL for safe fallback + LOGIN_PATH) -->
  <script src="/env.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    (async function () {
      const params = new URLSearchParams(location.search);
      const redirectParam = params.get('redirect') || '/your-impact';

      const redirectPath =
        redirectParam.startsWith('/') ? redirectParam : '/your-impact';

      const SUPABASE_URL = window.SUPABASE_URL || '';
      const SUPABASE_KEY = window.SUPABASE_ANON_KEY || '';

      if (!SUPABASE_URL || !SUPABASE_KEY || !window.supabase) {
        console.error('Supabase env not configured on /login');
        // In worst case, go straight to dashboard and let that page handle auth.
        location.replace(redirectPath);
        return;
      }

      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // 1) If already signed in, just go to the target page.
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
          location.replace(redirectPath);
          return;
        }
      } catch (e) {
        console.warn('getSession failed on /login, continuing to OAuth', e);
      }

      // 2) Prevent multiple OAuth starts
      if (window.__hayloLoginStarted) return;
      window.__hayloLoginStarted = true;

      // 3) Start Google OAuth and send user back to /auth/google as callback
      try {
        const { error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo:
              location.origin +
              '/auth/google?redirect=' +
              encodeURIComponent(redirectPath)
          }
        });

        if (error) {
          console.error('Google OAuth error on /login', error);
          alert('Unable to start Google sign-in. Please try again.');
        }
      } catch (e) {
        console.error('Unexpected error starting sign-in from /login', e);
        alert('Something went wrong starting sign-in.');
      }
    })();
  </script>

  <!-- No-JS fallback: send to canonical login with default redirect -->
  <noscript>
    <meta http-equiv="refresh" content="0;url=/auth/google?redirect=/your-impact">
  </noscript>
</head>
<body>
  <p>Redirecting…</p>
</body>
</html>
