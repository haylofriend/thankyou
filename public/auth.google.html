<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Signing in with Google…</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://accounts.google.com" crossorigin>
  <script src="/api/env.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
      background: #050506;
      color: #f4f4f5;
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: rgba(15, 15, 20, 0.9);
      border: 1px solid rgba(231,231,234,.12);
      border-radius: 20px;
      padding: 32px;
      max-width: 360px;
      text-align: center;
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
    }
    .spinner {
      margin: 0 auto 16px;
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 3px solid rgba(77,163,255,.35);
      border-top-color: rgba(77,163,255,.95);
      animation: spin 0.8s linear infinite;
    }
    a {
      color: #4da3ff;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="spinner" aria-hidden="true"></div>
    <h1 style="font-size:1.25rem;margin:0 0 0.5rem;">Connecting with Google…</h1>
    <p id="status" style="margin:0;color:rgba(244,244,245,.7);font-size:0.95rem;">Please wait while we redirect you.</p>
    <p style="margin-top:1.25rem;font-size:0.75rem;color:rgba(244,244,245,.5);">If nothing happens, <a id="manualLink" href="#">continue here</a>.</p>
  </div>
  <noscript>
    <meta http-equiv="refresh" content="0;url=/login?redirect=/your-impact">
  </noscript>
  <script>
    (function () {
      const statusEl = document.getElementById('status');
      const manualLink = document.getElementById('manualLink');
      const fallback = window.HF_DASHBOARD_URL || '/your-impact';

      function normalizeRedirect(value) {
        if (!value) return fallback;
        try {
          const url = new URL(value, location.origin);
          if (url.origin !== location.origin) return fallback;
          return url.pathname + (url.search || '') + (url.hash || '');
        } catch (_) {
          return fallback;
        }
      }

      function buildAuthorizeUrl(base, target) {
        const cleanBase = (base || '').replace(/\/+$/, '');
        if (!cleanBase) return null;
        const redirectTo = new URL(target, location.origin);
        const authorize = new URL(cleanBase + '/auth/v1/authorize');
        authorize.searchParams.set('provider', 'google');
        authorize.searchParams.set('redirect_to', redirectTo.toString());
        return authorize.toString();
      }

      async function go() {
        try {
          const params = new URLSearchParams(location.search);
          const redirectPath = normalizeRedirect(params.get('redirect'));
          const targetUrl = location.origin + redirectPath;
          manualLink.href = redirectPath;

          const supabaseUrl = window.SUPABASE_URL || '';
          const supabaseKey = window.SUPABASE_ANON_KEY || '';

          if (window.supabase && supabaseUrl && supabaseKey) {
            try {
              const client = window.supabase.createClient(supabaseUrl, supabaseKey);
              const { data: { session } } = await client.auth.getSession();
              if (session) {
                location.replace(redirectPath);
                return;
              }
            } catch (sessionError) {
              console.warn('Session check failed', sessionError);
            }
          }

          const authorizeUrl = buildAuthorizeUrl(supabaseUrl, targetUrl);
          if (!authorizeUrl) {
            statusEl.textContent = 'Unable to reach the sign-in service. Taking you to your dashboard.';
            setTimeout(() => location.replace(redirectPath), 800);
            return;
          }

          location.replace(authorizeUrl);
        } catch (error) {
          console.error('Google auth redirect failed', error);
          statusEl.textContent = 'Something went wrong. Tap continue to proceed.';
        }
      }

      setTimeout(() => {
        if (statusEl.textContent === 'Please wait while we redirect you.') {
          statusEl.textContent = 'This is taking a bit longer than usual…';
        }
      }, 4000);

      go();
    })();
  </script>
</body>
</html>
