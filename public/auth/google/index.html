<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Connecting with Google…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/env.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Minimal, dependency-free launcher for Supabase Google auth.
    (function () {
      function q(name){ return new URL(location.href).searchParams.get(name) }
      function toAbs(path){ try{ return new URL(path, location.origin).toString() }catch(_){ return location.origin + (path||'/' ) } }

      var SUPABASE_URL = (window.NEXT_PUBLIC_SUPABASE_URL||'').trim();
      var ANON = (window.NEXT_PUBLIC_SUPABASE_ANON_KEY||'').trim();

      // Pick redirect target:
      // 1) explicit ?redirect=… wins
      // 2) legacy ?autostart=1 falls back to /your-impact
      // 3) final fallback: /your-impact
      var redirectParam = q('redirect');
      var autostart = q('autostart');
      var redirectPath = redirectParam || (autostart ? '/your-impact' : '/your-impact');

      // If already signed in, just go to the redirect target.
      try {
        var hasSb = document.cookie.match(/(?:^|;\s*)sb-access-token=/) ||
                    document.cookie.match(/(?:^|;\s*)supabase.auth.token=/);
        if (hasSb) { location.replace(toAbs(redirectPath)); return; }
      } catch(_){}

      if(!SUPABASE_URL || !ANON){
        // Fail safe: bounce to public site if env missing
        location.replace(toAbs(redirectPath)); return;
      }

      // Build Supabase authorize URL for Google
      var authorize = new URL('/auth/v1/authorize', SUPABASE_URL);
      authorize.searchParams.set('provider', 'google');
      authorize.searchParams.set('redirect_to', toAbs(redirectPath));

      // Optional UX: carry through any state you want (nonce, etc.)
      // authorize.searchParams.set('scopes','');

      location.replace(authorize.toString());
    })();
  </script>
  <style>
    html,body{height:100%;margin:0;background:#0b0b0c;color:#e7e7ea;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{height:100%;display:grid;place-items:center}
    .card{padding:24px 28px;border:1px solid #2a2a2b;border-radius:16px;background:#121214}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">Connecting to Google…</div>
  </div>
</body>
</html>
