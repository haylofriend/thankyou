<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Connecting with Google…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/env.js"></script>
  <script src="/haylo-redirect.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Minimal, safe launcher for Supabase Google auth.
    (function () {
      function q(name) {
        return new URL(location.href).searchParams.get(name);
      }

      var SUPABASE_URL = (window.NEXT_PUBLIC_SUPABASE_URL || "").trim();
      var ANON = (window.NEXT_PUBLIC_SUPABASE_ANON_KEY || "").trim();
      var FALLBACK_PATH = "/your-impact";

      function safeRelRedirect(raw) {
        try {
          if (window.HayloRedirect && typeof HayloRedirect.normalize === "function") {
            return HayloRedirect.normalize(raw, FALLBACK_PATH);
          }
        } catch (_) {}
        // Very conservative local fallback: same-origin only, no whitelist
        if (!raw) return FALLBACK_PATH;
        try {
          var base = location.origin;
          var u = new URL(raw, base);
          if (u.origin !== base) return FALLBACK_PATH;
          return u.pathname + (u.search || "") + (u.hash || "");
        } catch (_) {
          return FALLBACK_PATH;
        }
      }

      function safeAbsRedirect(raw) {
        try {
          if (window.HayloRedirect && typeof HayloRedirect.abs === "function") {
            return HayloRedirect.abs(raw, FALLBACK_PATH);
          }
        } catch (_) {}
        // Fallback if HayloRedirect is unavailable
        var rel = safeRelRedirect(raw);
        try {
          return new URL(rel, location.origin).toString();
        } catch (_) {
          return location.origin + rel;
        }
      }

      var redirectParam = q("redirect");
      var autostart = q("autostart");

      // Decide where we *intend* to send users after Google
      var redirectPath = safeRelRedirect(
        redirectParam || (autostart ? FALLBACK_PATH : FALLBACK_PATH)
      );

      // If already signed in, just go to the sanitized target.
      try {
        var hasSb =
          document.cookie.match(/(?:^|;\s*)sb-access-token=/) ||
          document.cookie.match(/(?:^|;\s*)supabase\.auth\.token=/);

        if (hasSb) {
          location.replace(safeAbsRedirect(redirectPath));
          return;
        }
      } catch (_) {
        // ignore and fall through
      }

      if (!SUPABASE_URL || !ANON) {
        // Fail safe: go to the local dashboard fallback, never off-origin
        location.replace(safeAbsRedirect(redirectPath));
        return;
      }

      // Build Supabase authorize URL for Google with a safe redirect_to
      var authorize = new URL("/auth/v1/authorize", SUPABASE_URL);
      authorize.searchParams.set("provider", "google");
      authorize.searchParams.set("redirect_to", safeAbsRedirect(redirectPath));

      location.replace(authorize.toString());
    })();
  </script>
  <style>
    html,body{height:100%;margin:0;background:#0b0b0c;color:#e7e7ea;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{height:100%;display:grid;place-items:center}
    .card{padding:24px 28px;border:1px solid #2a2a2b;border-radius:16px;background:#121214}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">Connecting to Google…</div>
  </div>
</body>
</html>
